# ðŸ—„ï¸ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ

Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ÙØ§ÛŒÙ„ JSON

**Ù†Ø³Ø®Ù‡**: 2.0.0 | **Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ**: Ø¢Ú¯ÙˆØ³Øª 2025

---

## ðŸŽ¯ Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ

Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ø² ÛŒÚ© Ø³ÛŒØ³ØªÙ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± **ÙØ§ÛŒÙ„ JSON** Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú© ØªØ§ Ù…ØªÙˆØ³Ø· Ø¨Ø³ÛŒØ§Ø± Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³Øª Ùˆ Ù…Ø²Ø§ÛŒØ§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø§Ø±Ø¯:

### Ù…Ø²Ø§ÛŒØ§ÛŒ Ø³ÛŒØ³ØªÙ… ÙØ¹Ù„ÛŒ
- **Ø³Ø§Ø¯Ú¯ÛŒ**: Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù¾ÛŒÚ†ÛŒØ¯Ù‡
- **Ø³Ø±Ø¹Øª**: Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- **Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ù†ØªÙ‚Ø§Ù„**: Ø¢Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ backup Ùˆ migration
- **Ø¹Ø¯Ù… ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ**: Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†ØµØ¨ database server
- **Ø´ÙØ§ÙÛŒØª**: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ØªÙˆØ³Ø· Ø§Ù†Ø³Ø§Ù†
- **Atomic Operations**: Ø¹Ù…Ù„ÛŒØ§Øª Ø§ÛŒÙ…Ù† Ø¨Ø§ file locking

### Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
- **Scalability**: Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯
- **Concurrent Access**: Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†
- **Querying**: Ø¹Ø¯Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² complex queries
- **Indexing**: ÙÙ‚Ø¯Ø§Ù† Ø³ÛŒØ³ØªÙ… Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø®ÙˆØ¯Ú©Ø§Ø±

---

## ðŸ“ Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§

```
ðŸ“¦ Ù¾Ø±ÙˆÚ˜Ù‡/
â”œâ”€â”€ ðŸ“ users/                    # Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
â”‚   â”œâ”€â”€ ðŸ“„ users.json            # Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ØµÙ„ÛŒ
â”‚   â””â”€â”€ ðŸ“„ users.json.backup     # ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ø®ÙˆØ¯Ú©Ø§Ø±)
â”œâ”€â”€ ðŸ“ chats/                    # Ø°Ø®ÛŒØ±Ù‡ Ú†Øªâ€ŒÙ‡Ø§
â”‚   â”œâ”€â”€ ðŸ“ username1/            # Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± 1
â”‚   â”‚   â”œâ”€â”€ ðŸ“„ chat_id1.json     # Ú†Øª Ø§ÙˆÙ„
â”‚   â”‚   â”œâ”€â”€ ðŸ“„ chat_id2.json     # Ú†Øª Ø¯ÙˆÙ…
â”‚   â”‚   â””â”€â”€ ðŸ“„ ...
â”‚   â”œâ”€â”€ ðŸ“ username2/            # Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± 2
â”‚   â””â”€â”€ ðŸ“ ...
â””â”€â”€ ðŸ“ logs/                     # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ú¯
    â”œâ”€â”€ ðŸ“„ combined.log          # ØªÙ…Ø§Ù… Ù„Ø§Ú¯â€ŒÙ‡Ø§
    â”œâ”€â”€ ðŸ“„ error.log             # ÙÙ‚Ø· Ø®Ø·Ø§Ù‡Ø§
    â””â”€â”€ ðŸ“„ access.log            # Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ HTTP
```

---

## ðŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

### ÙØ§ÛŒÙ„: `users/users.json`

#### Ø³Ø§Ø®ØªØ§Ø± Ú©Ù„ÛŒ
```json
{
  "users": [
    {
      "username": "string (unique identifier)",
      "passwordHash": "string (scrypt format: scrypt:salt:hash)",
      "firstName": "string (optional)",
      "lastName": "string (optional)",
      "mobile": "string (optional)",
      "email": "string (optional)",
      "role": "user|admin (default: user)",
      "isActive": "boolean (default: true)",
      "maxChats": "number|null (Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ú†Øª)",
      "maxMessagesPerChat": "number|null (Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù¾ÛŒØ§Ù… Ø¯Ø± Ú†Øª)",
      "expiryDate": "string|null (YYYY-MM-DD format)",
      "stats": {
        "totalChats": "number (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú†Øªâ€ŒÙ‡Ø§)",
        "totalMessages": "number (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§)",
        "lastLoginAt": "string|null (ISO timestamp)"
      },
      "ttsSettings": {
        "voice": "string (ØµØ¯Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)",
        "speed": "number (Ø³Ø±Ø¹Øª Ù¾Ø®Ø´)",
        "quality": "string (Ú©ÛŒÙÛŒØª ØµÙˆØª)",
        "gender": "string (Ø¬Ù†Ø³ÛŒØª ØµØ¯Ø§)",
        "costTier": "string (Ø³Ø·Ø­ Ù‡Ø²ÛŒÙ†Ù‡)"
      }
    }
  ]
}
```

#### Ù…Ø«Ø§Ù„ Ú©Ø§Ø±Ø¨Ø± Ú©Ø§Ù…Ù„
```json
{
  "users": [
    {
      "username": "admin",
      "passwordHash": "scrypt:a1b2c3d4e5f6:1234567890abcdef...",
      "firstName": "Ù…Ø¯ÛŒØ±",
      "lastName": "Ø³ÛŒØ³ØªÙ…",
      "mobile": "09123456789",
      "email": "admin@example.com",
      "role": "admin",
      "isActive": true,
      "maxChats": null,
      "maxMessagesPerChat": null,
      "expiryDate": null,
      "stats": {
        "totalChats": 15,
        "totalMessages": 147,
        "lastLoginAt": "2025-08-20T10:30:00.000Z"
      },
      "ttsSettings": {
        "voice": "alloy",
        "speed": 1.0,
        "quality": "standard",
        "gender": "neutral",
        "costTier": "medium"
      }
    },
    {
      "username": "user123",
      "passwordHash": "scrypt:f6e5d4c3b2a1:fedcba0987654321...",
      "firstName": "Ø¹Ù„ÛŒ",
      "lastName": "Ø§Ø­Ù…Ø¯ÛŒ",
      "mobile": "09987654321",
      "email": "ali@example.com",
      "role": "user",
      "isActive": true,
      "maxChats": 10,
      "maxMessagesPerChat": 20,
      "expiryDate": "2025-12-31",
      "stats": {
        "totalChats": 3,
        "totalMessages": 28,
        "lastLoginAt": "2025-08-20T09:15:00.000Z"
      },
      "ttsSettings": {
        "voice": "nova",
        "speed": 1.2,
        "quality": "hd",
        "gender": "female",
        "costTier": "low"
      }
    }
  ]
}
```

#### ØªÙˆØ¶ÛŒØ­ ÙÛŒÙ„Ø¯Ù‡Ø§

**ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ:**
- `username`: Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ú©Ø§Ø±Ø¨Ø± (required, unique)
- `passwordHash`: Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù‡Ø´ Ø´Ø¯Ù‡ Ø¨Ø§ Scrypt (required)
- `role`: Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± - "user" ÛŒØ§ "admin" (default: "user")
- `isActive`: ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ (default: true)

**ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:**
- `firstName`, `lastName`: Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ (optional)
- `mobile`: Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ ÙØ±Ù…Øª 09xxxxxxxxx (optional)
- `email`: Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ (optional)

**Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§:**
- `maxChats`: Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ú†Øª Ù…Ø¬Ø§Ø² (null = unlimited)
- `maxMessagesPerChat`: Ø­Ø¯Ø§Ú©Ø«Ø± Ù¾ÛŒØ§Ù… Ø¯Ø± Ù‡Ø± Ú†Øª (null = unlimited)
- `expiryDate`: ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø­Ø³Ø§Ø¨ (YYYY-MM-DD format)

**Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±ÛŒ:**
- `stats.totalChats`: ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ (auto-calculated)
- `stats.totalMessages`: ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ (auto-calculated)
- `stats.lastLoginAt`: Ø¢Ø®Ø±ÛŒÙ† Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯ (ISO timestamp)

**ØªÙ†Ø¸ÛŒÙ…Ø§Øª TTS:**
- `voice`: ØµØ¯Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø² 6 ØµØ¯Ø§ÛŒ OpenAI
- `speed`: Ø³Ø±Ø¹Øª Ù¾Ø®Ø´ (0.25-2.0)
- `quality`: Ú©ÛŒÙÛŒØª ØµÙˆØª (standard/hd)
- `gender`: Ø¬Ù†Ø³ÛŒØª ØµØ¯Ø§ (male/female/neutral)
- `costTier`: Ø³Ø·Ø­ Ù‡Ø²ÛŒÙ†Ù‡ (low/medium/high)

---

## ðŸ’¬ Ù…Ø¯ÛŒØ±ÛŒØª Ú†Øªâ€ŒÙ‡Ø§

### Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ
```
chats/
â”œâ”€â”€ admin/
â”‚   â”œâ”€â”€ chat_abc123def456.json
â”‚   â”œâ”€â”€ chat_xyz789ghi012.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ user123/
â”‚   â”œâ”€â”€ chat_def456abc123.json
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

### ÙØ§ÛŒÙ„: `chats/{username}/{chatId}.json`

#### Ø³Ø§Ø®ØªØ§Ø± Ú†Øª
```json
{
  "id": "string (chat identifier)",
  "subject": "string (chat subject/title)", 
  "createdAt": "string (ISO timestamp)",
  "updatedAt": "string (ISO timestamp)",
  "messageCount": "number (ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§)",
  "model": "string (Ù…Ø¯Ù„ AI Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡)",
  "messages": [
    {
      "id": "string (message identifier)",
      "role": "user|assistant",
      "content": "string (message content)",
      "timestamp": "string (ISO timestamp)",
      "model": "string (Ù…Ø¯Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù¾ÛŒØ§Ù…)",
      "tokens": "number (ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† Ù…ØµØ±ÙÛŒ)",
      "cost": "number (Ù‡Ø²ÛŒÙ†Ù‡ ØªØ®Ù…ÛŒÙ†ÛŒ)"
    }
  ],
  "metadata": {
    "totalTokens": "number",
    "totalCost": "number",
    "averageResponseTime": "number (ms)",
    "isPinned": "boolean",
    "isArchived": "boolean",
    "tags": ["array of strings"]
  }
}
```

#### Ù…Ø«Ø§Ù„ Ú†Øª Ú©Ø§Ù…Ù„
```json
{
  "id": "chat_abc123def456", 
  "subject": "Ø³ÙˆØ§Ù„ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ JavaScript",
  "createdAt": "2025-08-20T10:30:00.000Z",
  "updatedAt": "2025-08-20T11:15:30.000Z",
  "messageCount": 4,
  "model": "gpt-4o-mini",
  "messages": [
    {
      "id": "msg_user_001",
      "role": "user",
      "content": "Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… ÛŒÚ© API Ø¯Ø± Node.js Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ù…ØŸ",
      "timestamp": "2025-08-20T10:30:15.000Z",
      "model": null,
      "tokens": 0,
      "cost": 0
    },
    {
      "id": "msg_assistant_002",
      "role": "assistant", 
      "content": "Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ API Ø¯Ø± Node.js Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ø§Ø² Express.js Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯...",
      "timestamp": "2025-08-20T10:30:18.000Z",
      "model": "gpt-4o-mini",
      "tokens": 150,
      "cost": 0.0002
    },
    {
      "id": "msg_user_003",
      "role": "user",
      "content": "Ù…Ù…Ù†ÙˆÙ†! ÛŒÚ© Ù…Ø«Ø§Ù„ Ú©Ø§Ù…Ù„ Ù‡Ù… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ø¨Ø¯ÛŒØ¯ØŸ",
      "timestamp": "2025-08-20T11:10:00.000Z",
      "model": null,
      "tokens": 0,
      "cost": 0
    },
    {
      "id": "msg_assistant_004",
      "role": "assistant",
      "content": "Ø§Ù„Ø¨ØªÙ‡! Ø§ÛŒÙ† ÛŒÚ© Ù…Ø«Ø§Ù„ Ú©Ø§Ù…Ù„ Ø§Ø³Øª:\n\n```javascript\nconst express = require('express');\nconst app = express();\n\napp.get('/api/users', (req, res) => {\n  res.json({ users: [] });\n});\n\napp.listen(3000);\n```",
      "timestamp": "2025-08-20T11:15:30.000Z",
      "model": "gpt-4o-mini",
      "tokens": 89,
      "cost": 0.0001
    }
  ],
  "metadata": {
    "totalTokens": 239,
    "totalCost": 0.0003,
    "averageResponseTime": 2500,
    "isPinned": false,
    "isArchived": false,
    "tags": ["Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ", "Node.js", "API"]
  }
}
```

#### ØªÙˆØ¶ÛŒØ­ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù¾ÛŒØ§Ù…
- `id`: Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ù¾ÛŒØ§Ù… (auto-generated)
- `role`: Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù… - "user" ÛŒØ§ "assistant"
- `content`: Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ§Ù… (max 4000 chars)
- `timestamp`: Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„ (ISO format)
- `model`: Ù…Ø¯Ù„ AI Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ assistant
- `tokens`: ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† Ù…ØµØ±ÙÛŒ
- `cost`: Ù‡Ø²ÛŒÙ†Ù‡ ØªØ®Ù…ÛŒÙ†ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø±Ø® OpenAI

---

## ðŸ”§ Helper Functions Ùˆ Operations

### helpers/fs.js - Ø¹Ù…Ù„ÛŒØ§Øª ÙØ§ÛŒÙ„

#### ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ú†Øª
```javascript
/**
 * Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ú†Øª Ú©Ø§Ø±Ø¨Ø±
 */
async function ensureChatDir(username) {
  const chatDir = path.join('chats', username);
  if (!fs.existsSync(chatDir)) {
    fs.mkdirSync(chatDir, { recursive: true });
  }
}

/**
 * Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ú†Øª
 */
async function readChatFile(username, chatId) {
  const filePath = path.join('chats', username, `${chatId}.json`);
  try {
    const data = fs.readFileSync(filePath, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    if (error.code === 'ENOENT') {
      return null; // ÙØ§ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
    }
    throw error;
  }
}

/**
 * Ù†ÙˆØ´ØªÙ† ÙØ§ÛŒÙ„ Ú†Øª
 */
async function writeChatFile(username, chat) {
  await ensureChatDir(username);
  const filePath = path.join('chats', username, `${chat.id}.json`);
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ timestamp
  chat.updatedAt = new Date().toISOString();
  chat.messageCount = chat.messages.length;
  
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ metadata
  chat.metadata = calculateChatMetadata(chat);
  
  // Ù†ÙˆØ´ØªÙ† atomic
  const tempFile = filePath + '.tmp';
  fs.writeFileSync(tempFile, JSON.stringify(chat, null, 2));
  fs.renameSync(tempFile, filePath);
}

/**
 * Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
 */
async function listChats(username) {
  const chatDir = path.join('chats', username);
  if (!fs.existsSync(chatDir)) {
    return [];
  }
  
  const files = fs.readdirSync(chatDir)
    .filter(file => file.endsWith('.json'))
    .map(file => file.replace('.json', ''));
    
  return files;
}

/**
 * Ø­Ø°Ù ÙØ§ÛŒÙ„ Ú†Øª
 */
async function deleteChatFile(username, chatId) {
  const filePath = path.join('chats', username, `${chatId}.json`);
  if (fs.existsSync(filePath)) {
    fs.unlinkSync(filePath);
    return true;
  }
  return false;
}
```

### helpers/auth.js - Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

#### ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
```javascript
/**
 * Ø®ÙˆØ§Ù†Ø¯Ù† ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
 */
async function readUsers() {
  const filePath = path.join('users', 'users.json');
  try {
    const data = fs.readFileSync(filePath, 'utf8');
    const parsed = JSON.parse(data);
    return parsed.users || [];
  } catch (error) {
    return [];
  }
}

/**
 * Ù†ÙˆØ´ØªÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
 */
async function writeUsers(users) {
  const filePath = path.join('users', 'users.json');
  const backupPath = filePath + '.backup';
  
  // Ø§ÛŒØ¬Ø§Ø¯ backup Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±
  if (fs.existsSync(filePath)) {
    fs.copyFileSync(filePath, backupPath);
  }
  
  const data = {
    users: users,
    lastUpdated: new Date().toISOString(),
    version: "2.0.0"
  };
  
  // Ù†ÙˆØ´ØªÙ† atomic
  const tempFile = filePath + '.tmp';
  fs.writeFileSync(tempFile, JSON.stringify(data, null, 2));
  fs.renameSync(tempFile, filePath);
}

/**
 * ÛŒØ§ÙØªÙ† Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ
 */
async function findUser(username) {
  const users = await readUsers();
  return users.find(user => user.username === username);
}

/**
 * Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
 */
async function createUser(username, password, details = {}) {
  const users = await readUsers();
  
  // Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨ÙˆØ¯Ù† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
  if (users.find(u => u.username === username)) {
    throw new Error('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª');
  }
  
  const newUser = {
    username,
    passwordHash: await hashPassword(password),
    firstName: details.firstName || '',
    lastName: details.lastName || '',
    mobile: details.mobile || '',
    email: details.email || '',
    role: details.role || 'user',
    isActive: details.isActive !== false,
    maxChats: details.maxChats || null,
    maxMessagesPerChat: details.maxMessagesPerChat || null,
    expiryDate: details.expiryDate || null,
    stats: {
      totalChats: 0,
      totalMessages: 0,
      lastLoginAt: null
    },
    ttsSettings: {
      voice: 'alloy',
      speed: 1.0,
      quality: 'standard',
      gender: 'neutral',
      costTier: 'medium'
    }
  };
  
  users.push(newUser);
  await writeUsers(users);
  
  return newUser;
}
```

---

## ðŸ” Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§

### User Validation
```javascript
// Username validation
const isValidUsername = (username) => {
  return username && 
         typeof username === 'string' && 
         username.length >= 3 && 
         username.length <= 30 &&
         /^[a-zA-Z0-9_]+$/.test(username);
};

// Password validation  
const isValidPassword = (password) => {
  return password && 
         typeof password === 'string' && 
         password.length >= 6 && 
         password.length <= 100;
};

// Email validation
const isValidEmail = (email) => {
  if (!email) return true; // optional field
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
};

// Mobile validation
const isValidMobile = (mobile) => {
  if (!mobile) return true; // optional field
  return /^09\d{9}$/.test(mobile);
};

// Date validation
const isValidDate = (dateString) => {
  if (!dateString) return true; // null allowed
  return /^\d{4}-\d{2}-\d{2}$/.test(dateString) && 
         !isNaN(Date.parse(dateString));
};
```

### Chat Validation
```javascript
// Subject validation
const isValidSubject = (subject) => {
  return subject && 
         typeof subject === 'string' && 
         subject.trim().length > 0 && 
         subject.length <= 100;
};

// Message content validation
const isValidContent = (content) => {
  return content && 
         typeof content === 'string' && 
         content.trim().length > 0 && 
         content.length <= 4000;
};
```

---

## ðŸ“Š Performance Ùˆ Optimization

### File Locking
```javascript
const lockfile = require('proper-lockfile');

async function safeFileOperation(filePath, operation) {
  const release = await lockfile.lock(filePath);
  try {
    return await operation();
  } finally {
    await release();
  }
}
```

### Caching Strategy
```javascript
const userCache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

function getCachedUser(username) {
  const cached = userCache.get(username);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }
  return null;
}

function setCachedUser(username, userData) {
  userCache.set(username, {
    data: userData,
    timestamp: Date.now()
  });
}
```

### Backup Strategy
```javascript
async function createBackup() {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const backupDir = `backup_${timestamp}`;
  
  // Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† users
  fs.copyFileSync('users/users.json', `${backupDir}/users.json`);
  
  // Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† chats
  fs.cpSync('chats', `${backupDir}/chats`, { recursive: true });
  
  // Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ metadata
  const metadata = {
    timestamp,
    version: "2.0.0",
    userCount: (await readUsers()).length,
    chatCount: await getTotalChatCount()
  };
  
  fs.writeFileSync(`${backupDir}/metadata.json`, 
    JSON.stringify(metadata, null, 2));
}
```

---

## ðŸ“ˆ Migration Ùˆ Upgrade Path

### Ù†Ø³Ø®Ù‡ 2.1 (PostgreSQL Migration)
```javascript
// Migration script Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ PostgreSQL
async function migrateToPostgreSQL() {
  const users = await readUsers();
  const client = new Client(DATABASE_CONFIG);
  
  await client.connect();
  
  // Migration users
  for (const user of users) {
    await client.query(`
      INSERT INTO users (username, password_hash, first_name, ...)
      VALUES ($1, $2, $3, ...)
    `, [user.username, user.passwordHash, user.firstName, ...]);
  }
  
  // Migration chats
  // ... similar process for chats
  
  await client.end();
}
```

### Data Integrity Checks
```javascript
async function validateDataIntegrity() {
  const errors = [];
  
  // Ø¨Ø±Ø±Ø³ÛŒ users
  const users = await readUsers();
  for (const user of users) {
    if (!isValidUsername(user.username)) {
      errors.push(`Invalid username: ${user.username}`);
    }
    // ... other validations
  }
  
  // Ø¨Ø±Ø±Ø³ÛŒ chats
  for (const user of users) {
    const chatIds = await listChats(user.username);
    for (const chatId of chatIds) {
      const chat = await readChatFile(user.username, chatId);
      if (!chat || !chat.messages) {
        errors.push(`Invalid chat: ${chatId}`);
      }
    }
  }
  
  return errors;
}
```

---

## ðŸ›¡ï¸ Security Considerations

### File Permissions
```bash
# ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ ÙØ§ÛŒÙ„
chmod 600 users/users.json      # ÙÙ‚Ø· ØµØ§Ø­Ø¨ ÙØ§ÛŒÙ„
chmod 700 users/                # ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ
chmod 755 chats/                # Ø®ÙˆØ§Ù†Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ØŒ Ù†ÙˆØ´ØªÙ† ÙÙ‚Ø· ØµØ§Ø­Ø¨
```

### Data Encryption
```javascript
// Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø­Ø³Ø§Ø³ data
const crypto = require('crypto');

function encryptSensitiveData(data, key) {
  const cipher = crypto.createCipher('aes-256-cbc', key);
  let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return encrypted;
}

function decryptSensitiveData(encryptedData, key) {
  const decipher = crypto.createDecipher('aes-256-cbc', key);
  let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return JSON.parse(decrypted);
}
```

---

## ðŸ“Š Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§

### ØªÙˆÙ„ÛŒØ¯ Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…
```javascript
async function generateSystemStats() {
  const users = await readUsers();
  const activeUsers = users.filter(u => u.isActive);
  
  let totalChats = 0;
  let totalMessages = 0;
  
  for (const user of users) {
    const chatIds = await listChats(user.username);
    totalChats += chatIds.length;
    
    for (const chatId of chatIds) {
      const chat = await readChatFile(user.username, chatId);
      if (chat) {
        totalMessages += chat.messages.length;
      }
    }
  }
  
  return {
    users: {
      total: users.length,
      active: activeUsers.length,
      admins: users.filter(u => u.role === 'admin').length
    },
    chats: {
      total: totalChats,
      averagePerUser: totalChats / users.length
    },
    messages: {
      total: totalMessages,
      averagePerChat: totalMessages / totalChats
    },
    storage: {
      usersFileSize: getFileSize('users/users.json'),
      chatsTotalSize: getDirSize('chats/')
    }
  };
}
```

---

**Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ**: Ø¢Ú¯ÙˆØ³Øª 2025 | **Ù†Ø³Ø®Ù‡**: 2.0.0